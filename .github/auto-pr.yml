name: Auto PR: develop → main

on:
  push:
    branches: [develop]

# Avoid overlapping runs editing the same PR
concurrency:
  group: auto-pr-from-develop
  cancel-in-progress: false

jobs:
  open_or_update_pr:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Open or update PR develop → main
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const head = "develop";
            const base = "main";

            // Use latest commit message for the title (fallback provided)
            const latestMessage =
              context.payload.head_commit?.message ||
              (Array.isArray(context.payload.commits) && context.payload.commits.slice(-1)[0]?.message) ||
              `Sync ${head} → ${base}`;

            // Look for an existing OPEN PR from develop to main
            const { data: openPRs } = await github.rest.pulls.list({
              owner,
              repo,
              state: "open",
              base,
              head: `${owner}:${head}`,
              per_page: 100,
            });

            if (openPRs.length > 0) {
              const pr = openPRs[0];

              // Only update title if it changed
              if (pr.title !== latestMessage) {
                await github.rest.pulls.update({
                  owner,
                  repo,
                  pull_number: pr.number,
                  title: latestMessage,
                });
                core.info(`Updated PR #${pr.number} title.`);
              } else {
                core.info(`PR #${pr.number} already has the latest title.`);
              }

              core.setOutput("pr_number", pr.number);
              return;
            }

            // No open PR—create one
            const { data: newPR } = await github.rest.pulls.create({
              owner,
              repo,
              base,
              head,
              title: latestMessage,
              body: "Automated PR to merge `develop` into `main`.",
              maintainer_can_modify: true,
            });

            core.info(`Created PR #${newPR.number}.`);
            core.setOutput("pr_number", newPR.number);
